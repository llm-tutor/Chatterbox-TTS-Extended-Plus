openapi: 3.0.3
info:
  title: Chatterbox TTS Extended Plus API
  description: Advanced Text-to-Speech and Voice Conversion API with chunking, retry logic, Whisper validation, and comprehensive error handling
  version: 1.8.2
  contact:
    name: API Support
  license:
    name: MIT
    
servers:
  - url: http://localhost:7860
    description: Local development server

tags:
  - name: System
    description: System operations (health, config, voices)
  - name: TTS
    description: Text-to-Speech generation
  - name: Voice Conversion
    description: Voice conversion operations
  - name: Files
    description: File access and downloads

paths:
  /api/v1/health:
    get:
      summary: Health Check
      description: Check API health and system status
      operationId: healthCheck
      tags:
        - System
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                models_loaded:
                  tts: true
                  vc: true
                  whisper: true
                version: "1.0.0"
                uptime_seconds: 3600.5

  /api/v1/config:
    get:
      summary: Get Configuration
      description: Get API configuration and default values
      operationId: getConfig
      tags:
        - System
      responses:
        '200':
          description: Configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/voices:
    get:
      summary: List Available Voices
      description: Get list of available reference voice files with enhanced metadata, pagination, and search
      operationId: listVoices
      tags:
        - System
      parameters:
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          description: Items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: search
          in: query
          description: Search term for voice names, descriptions, or tags
          required: false
          schema:
            type: string
        - name: folder
          in: query
          description: Filter by folder path
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Voices retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoicesResponse'

  /api/v1/resources:
    get:
      summary: Get Resource Status
      description: Get current resource usage status including disk space, file counts, and warnings
      operationId: getResourceStatus
      tags:
        - System
      responses:
        '200':
          description: Resource status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceStatusResponse'
              example:
                timestamp: "2025-06-19T23:15:30.123456+00:00"
                directories:
                  outputs:
                    size_bytes: 1073741824
                    size_mb: 1024.0
                    max_size_mb: 5120.0
                    usage_percent: 20.0
                    file_count: 25
                  temp:
                    size_bytes: 52428800
                    size_mb: 50.0
                    file_count: 15
                    max_files: 200
                    usage_percent: 7.5
                  vc_inputs:
                    size_bytes: 524288000
                    size_mb: 500.0
                    max_size_mb: 2048.0
                    usage_percent: 24.4
                    file_count: 8
                warnings: []

  /api/v1/cleanup:
    post:
      summary: Force Cleanup
      description: Force immediate cleanup operation
      operationId: forceCleanup
      tags:
        - System
      responses:
        '200':
          description: Cleanup completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupResponse'
              example:
                timestamp: "2025-06-19T23:16:00.123456+00:00"
                forced: true
                total_files_removed: 12
                total_bytes_freed: 104857600
                duration_seconds: 1.25
                actions:
                  temp_age_cleanup:
                    files_removed: 5
                    bytes_freed: 52428800
                  temp_count_cleanup:
                    files_removed: 3
                    bytes_freed: 31457280
                  output_size_cleanup:
                    files_removed: 4
                    bytes_freed: 20971520

  /api/v1/cleanup/status:
    get:
      summary: Get Cleanup Status
      description: Get cleanup scheduler status and history
      operationId: getCleanupStatus
      tags:
        - System
      responses:
        '200':
          description: Cleanup status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupStatusResponse'
              example:
                scheduler:
                  running: true
                  cleanup_on_startup: true
                  cleanup_interval_hours: 5
                  last_cleanup_time: "2025-06-19T18:00:00.123456+00:00"
                  cleanup_count: 3
                  next_cleanup_time: "2025-06-19T23:00:00.123456+00:00"
                history:
                  - timestamp: "2025-06-19T18:00:00.123456+00:00"
                    total_files_removed: 8
                    total_bytes_freed: 83886080
                    duration_seconds: 0.85
                  - timestamp: "2025-06-19T13:00:00.123456+00:00"
                    total_files_removed: 5
                    total_bytes_freed: 52428800
                    duration_seconds: 0.62
  /api/v1/tts:
    post:
      summary: Text-to-Speech Generation
      description: Generate speech from text with optional voice cloning, streaming response, and enhanced features
      operationId: generateTTS
      tags:
        - TTS
      parameters:
        - name: response_mode
          in: query
          description: Response mode - 'stream' for direct file download, 'url' for JSON response
          required: false
          schema:
            type: string
            enum: [stream, url, file, download]
            default: stream
        - name: return_format
          in: query
          description: Format to stream (wav, mp3, flac). If not specified, uses first format from export_formats
          required: false
          schema:
            type: string
            enum: [wav, mp3, flac]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TTSRequest'
            examples:
              basic:
                summary: Basic TTS
                value:
                  text: "Hello, this is a basic TTS example."
                  export_formats: ["wav"]
              with_voice:
                summary: TTS with Voice Cloning
                value:
                  text: "This will be spoken in the reference voice style."
                  reference_audio_filename: "speaker1/formal.wav"
                  exaggeration: 0.7
                  temperature: 0.8
                  export_formats: ["wav", "mp3"]
      responses:
        '200':
          description: TTS generation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TTSResponse'
            application/octet-stream:
              schema:
                type: string
                format: binary
              description: Direct audio file download (when response_mode=stream)
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/vc:
    post:
      summary: Voice Conversion
      description: Convert voice characteristics of input audio to match a target voice with support for file uploads and streaming
      operationId: convertVoice
      tags:
        - Voice Conversion
      parameters:
        - name: response_mode
          in: query
          description: Response mode - 'stream' for direct file download, 'url' for JSON response
          required: false
          schema:
            type: string
            enum: [stream, url, file, download]
            default: stream
        - name: return_format
          in: query
          description: Format to stream (wav, mp3, flac). If not specified, uses first format from export_formats
          required: false
          schema:
            type: string
            enum: [wav, mp3, flac]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VCRequest'
            examples:
              local_files:
                summary: Local Files
                value:
                  input_audio_source: "my_recording.wav"
                  target_voice_source: "speaker1/formal.wav"
                  export_formats: ["wav"]
              with_urls:
                summary: With URL Input
                value:
                  input_audio_source: "https://example.com/speech.wav"
                  target_voice_source: "target_voices/celebrity.wav"
                  chunk_sec: 30
                  export_formats: ["wav", "mp3"]
          multipart/form-data:
            schema:
              type: object
              properties:
                input_audio:
                  type: string
                  format: binary
                  description: Input audio file to convert (max 100MB)
                target_voice_source:
                  type: string
                  description: Target voice source (filename or URL)
                chunk_sec:
                  type: integer
                  default: 60
                  description: Chunk size in seconds
                overlap_sec:
                  type: number
                  format: float
                  default: 0.1
                  description: Overlap in seconds
                disable_watermark:
                  type: boolean
                  default: true
                  description: Disable watermark
                export_formats:
                  type: string
                  default: "wav,mp3"
                  description: Comma-separated export formats
              required:
                - input_audio
                - target_voice_source
      responses:
        '200':
          description: Voice conversion successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VCResponse'
            application/octet-stream:
              schema:
                type: string
                format: binary
              description: Direct audio file download (when response_mode=stream)
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /outputs/{filename}:
    get:
      summary: Download Generated Audio
      description: Download generated audio files via HTTP
      operationId: downloadFile
      tags:
        - Files
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
          description: Name of the generated audio file
          example: "tts_output_1234567890_42.wav"
      responses:
        '200':
          description: File downloaded successfully
          content:
            audio/wav:
              schema:
                type: string
                format: binary
            audio/mpeg:
              schema:
                type: string
                format: binary
        '404':
          description: File not found

  /api/v1/errors/summary:
    get:
      summary: Get Error Summary
      description: Get comprehensive error summary for the last 24 hours with categorization
      operationId: getErrorSummary
      tags:
        - System
      responses:
        '200':
          description: Error summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorSummaryResponse'
              example:
                total_errors: 5
                by_category:
                  transient: 3
                  permanent: 2
                by_severity:
                  medium: 4
                  high: 1
                by_operation:
                  file_download: 3
                  tts_generation: 2
                most_frequent:
                  "file_download:ConnectionError": 3
                unresolved_count: 1
                recent_errors: []

  /api/v1/errors/recent:
    get:
      summary: Get Recent Errors
      description: Get recent errors for debugging purposes
      operationId: getRecentErrors
      tags:
        - System
      parameters:
        - name: count
          in: query
          description: Number of recent errors to retrieve (max 50)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          example: 10
      responses:
        '200':
          description: Recent errors retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  recent_errors:
                    type: array
                    items:
                      $ref: '#/components/schemas/ErrorRecord'
                  total_stored:
                    type: integer
                    description: Total number of errors stored in memory
              example:
                recent_errors:
                  - timestamp: "2025-06-19T10:30:00Z"
                    operation: "file_download"
                    error_type: "ConnectionError"
                    error_message: "Connection timeout"
                    category: "transient"
                    severity: "medium"
                    context:
                      url: "https://example.com/audio.wav"
                      attempt: 1
                    retry_count: 0
                    resolved: false
                total_stored: 47

components:
  schemas:
    TTSRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: Text to synthesize
          maxLength: 10000
          example: "Hello, this is a test of the TTS API."
        reference_audio_filename:
          type: string
          description: Reference audio file for voice cloning
          example: "speaker1/formal.wav"
        exaggeration:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          default: 0.5
          description: Voice expressiveness level
        temperature:
          type: number
          format: float
          minimum: 0.0
          maximum: 2.0
          default: 0.75
          description: Generation randomness
        seed:
          type: integer
          default: 0
          description: Random seed (0 for random)
        export_formats:
          type: array
          items:
            type: string
            enum: ["wav", "mp3", "flac"]
          default: ["wav", "mp3"]
          description: Output audio formats
        bypass_whisper_checking:
          type: boolean
          default: false
          description: Skip Whisper quality validation
        whisper_model_name:
          type: string
          enum: ["tiny", "base", "small", "medium", "large"]
          default: "medium"
          description: Whisper model size

    VCRequest:
      type: object
      required:
        - input_audio_source
        - target_voice_source
      properties:
        input_audio_source:
          type: string
          description: Source audio file or URL
          example: "my_recording.wav"
        target_voice_source:
          type: string
          description: Target voice file or URL
          example: "speaker1/formal.wav"
        chunk_sec:
          type: integer
          minimum: 10
          maximum: 300
          default: 60
          description: Chunk duration in seconds
        overlap_sec:
          type: number
          format: float
          minimum: 0.0
          maximum: 10.0
          default: 0.1
          description: Overlap for seamless joining
        export_formats:
          type: array
          items:
            type: string
            enum: ["wav", "mp3", "flac"]
          default: ["wav", "mp3"]
          description: Output audio formats

    AudioFile:
      type: object
      properties:
        format:
          type: string
          description: Audio file format
          example: "wav"
        filename:
          type: string
          description: Generated filename
          example: "tts_output_1234567890_42.wav"
        url:
          type: string
          description: HTTP URL for file access
          example: "/outputs/tts_output_1234567890_42.wav"

    BaseResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        message:
          type: string
          description: Response message

    TTSResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            output_files:
              type: array
              items:
                $ref: '#/components/schemas/AudioFile'
            generation_seed_used:
              type: integer
              description: Seed used for generation
            processing_time_seconds:
              type: number
              format: float
              description: Processing time

    VCResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            output_files:
              type: array
              items:
                $ref: '#/components/schemas/AudioFile'
            processing_time_seconds:
              type: number
              format: float
              description: Processing time

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        models_loaded:
          type: object
          properties:
            tts:
              type: boolean
            vc:
              type: boolean
            whisper:
              type: boolean
        version:
          type: string
        uptime_seconds:
          type: number
          format: float
        metrics:
          type: object
          description: Performance and system metrics
        system_info:
          type: object
          description: System information
        resource_status:
          $ref: '#/components/schemas/ResourceStatusResponse'
        warnings:
          type: array
          items:
            type: string
          description: System warnings
        error_summary:
          $ref: '#/components/schemas/ErrorSummaryResponse'
          description: Error summary for last 24 hours (only present if errors exist)

    ConfigResponse:
      type: object
      properties:
        tts_defaults:
          type: object
          description: Default TTS parameters
        vc_defaults:
          type: object
          description: Default VC parameters
        supported_formats:
          type: array
          items:
            type: string
          description: Supported audio formats
        api_limits:
          type: object
          description: API limitations

    VoicesResponse:
      type: object
      properties:
        voices:
          type: array
          items:
            $ref: '#/components/schemas/VoiceMetadata'
        count:
          type: integer
          description: Number of voices in current page
        page:
          type: integer
          description: Current page number
        page_size:
          type: integer
          description: Items per page
        total_pages:
          type: integer
          description: Total number of pages
        has_next:
          type: boolean
          description: Whether there is a next page
        has_previous:
          type: boolean
          description: Whether there is a previous page

    VoiceMetadata:
      type: object
      properties:
        name:
          type: string
          description: Voice identifier (filename without extension)
        description:
          type: string
          nullable: true
          description: Human-readable description
        duration_seconds:
          type: number
          nullable: true
          description: Audio duration in seconds
        sample_rate:
          type: integer
          nullable: true
          description: Audio sample rate (Hz)
        file_size_bytes:
          type: integer
          nullable: true
          description: File size in bytes
        format:
          type: string
          nullable: true
          description: Audio format (wav, mp3, flac, etc.)
        default_parameters:
          type: object
          nullable: true
          description: Recommended TTS parameters for this voice
        tags:
          type: array
          items:
            type: string
          description: Descriptive tags
        created_date:
          type: string
          format: date-time
          nullable: true
          description: ISO timestamp when voice was first added
        last_used:
          type: string
          format: date-time
          nullable: true
          description: ISO timestamp when voice was last used
        usage_count:
          type: integer
          description: Number of times voice has been used
        folder_path:
          type: string
          nullable: true
          description: Relative folder path within reference_audio/ (null for root)

    ResourceStatusResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of resource status check
        directories:
          type: object
          properties:
            outputs:
              $ref: '#/components/schemas/DirectoryInfo'
            temp:
              $ref: '#/components/schemas/TempDirectoryInfo'
            vc_inputs:
              $ref: '#/components/schemas/DirectoryInfo'
        warnings:
          type: array
          items:
            type: string
            description: Resource warning messages

    DirectoryInfo:
      type: object
      properties:
        size_bytes:
          type: integer
          description: Directory size in bytes
        size_mb:
          type: number
          format: float
          description: Directory size in megabytes
        max_size_mb:
          type: number
          format: float
          description: Maximum allowed size in megabytes
        usage_percent:
          type: number
          format: float
          description: Usage percentage of maximum size
        file_count:
          type: integer
          description: Number of files in directory

    TempDirectoryInfo:
      type: object
      properties:
        size_bytes:
          type: integer
          description: Directory size in bytes
        size_mb:
          type: number
          format: float
          description: Directory size in megabytes
        file_count:
          type: integer
          description: Number of files in directory
        max_files:
          type: integer
          description: Maximum allowed files
        usage_percent:
          type: number
          format: float
          description: Usage percentage of maximum file count

    CleanupResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Cleanup operation timestamp
        forced:
          type: boolean
          description: Whether this was a forced cleanup
        total_files_removed:
          type: integer
          description: Total number of files removed
        total_bytes_freed:
          type: integer
          description: Total bytes freed
        duration_seconds:
          type: number
          format: float
          description: Cleanup operation duration
        actions:
          type: object
          properties:
            temp_age_cleanup:
              $ref: '#/components/schemas/CleanupAction'
            temp_count_cleanup:
              $ref: '#/components/schemas/CleanupAction'
            output_size_cleanup:
              $ref: '#/components/schemas/CleanupAction'
            vc_inputs_size_cleanup:
              $ref: '#/components/schemas/CleanupAction'

    CleanupAction:
      type: object
      properties:
        files_removed:
          type: integer
          description: Files removed by this action
        bytes_freed:
          type: integer
          description: Bytes freed by this action

    CleanupStatusResponse:
      type: object
      properties:
        scheduler:
          type: object
          properties:
            running:
              type: boolean
              description: Whether scheduler is running
            cleanup_on_startup:
              type: boolean
              description: Whether cleanup runs on startup
            cleanup_interval_hours:
              type: integer
              description: Cleanup interval in hours
            last_cleanup_time:
              type: string
              format: date-time
              description: Last cleanup timestamp
            cleanup_count:
              type: integer
              description: Number of cleanups performed
            next_cleanup_time:
              type: string
              format: date-time
              description: Next scheduled cleanup time
        history:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              total_files_removed:
                type: integer
              total_bytes_freed:
                type: integer
              duration_seconds:
                type: number
                format: float

    ErrorSummaryResponse:
      type: object
      description: Comprehensive error summary with categorization
      properties:
        total_errors:
          type: integer
          description: Total number of errors in the time period
          example: 5
        by_category:
          type: object
          description: Error count by category
          additionalProperties:
            type: integer
          example:
            transient: 3
            permanent: 2
            resource: 0
            configuration: 0
        by_severity:
          type: object
          description: Error count by severity level
          additionalProperties:
            type: integer
          example:
            low: 0
            medium: 4
            high: 1
            critical: 0
        by_operation:
          type: object
          description: Error count by operation type
          additionalProperties:
            type: integer
          example:
            file_download: 3
            tts_generation: 2
        most_frequent:
          type: object
          description: Most frequently occurring errors (operation:error_type)
          additionalProperties:
            type: integer
          example:
            "file_download:ConnectionError": 3
        unresolved_count:
          type: integer
          description: Number of unresolved errors
          example: 1
        recent_errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorRecord'
          description: Recent error details

    ErrorRecord:
      type: object
      description: Individual error record with full context
      properties:
        timestamp:
          type: string
          format: date-time
          description: When the error occurred
          example: "2025-06-19T10:30:00Z"
        operation:
          type: string
          description: Operation that failed
          example: "file_download"
        error_type:
          type: string
          description: Type of error (exception class name)
          example: "ConnectionError"
        error_message:
          type: string
          description: Error message details
          example: "Connection timeout occurred"
        category:
          type: string
          enum: [transient, permanent, resource, configuration]
          description: Automatic error categorization
          example: "transient"
        severity:
          type: string
          enum: [low, medium, high, critical]
          description: Error severity level
          example: "medium"
        context:
          type: object
          description: Additional context about the error
          additionalProperties: true
          example:
            url: "https://example.com/audio.wav"
            attempt: 1
            timeout: 30
        retry_count:
          type: integer
          description: Number of retry attempts
          example: 0
        resolved:
          type: boolean
          description: Whether the error has been resolved
          example: false
        resolution_timestamp:
          type: string
          format: date-time
          description: When the error was resolved (if applicable)
          example: "2025-06-19T10:32:00Z"
          nullable: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
        error_code:
          type: string
          description: Error code
        detail:
          type: string
          description: Technical details

  responses:
    BadRequest:
      description: Bad request - Invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
